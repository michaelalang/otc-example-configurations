receivers:
  journald:
    directory: /run/log/journal # RHEL9, RHEL10/Fedora43 /var/log/journal containers use /host/...
    units: [] 
    start_at: end

  filelog/audit:
    include: [/var/log/audit/audit.log] # containers use /host/... you need to run the pod as privileged user
    start_at: end
    operators:
      - type: regex_parser
        regex: 'type=(?P<audit_type>[^ ]+)\s+msg=audit\((?P<audit_ts>[0-9\.]+):(?P<audit_id>\d+)\):\s*(?P<payload>.*)$'
      - type: time_parser
        parse_from: attributes.audit_ts
        layout_type: epoch
        layout: 's.ms' 
      - type: key_value_parser
        parse_from: attributes.payload
        parse_to: attributes
        delimiter: "=" 
        pair_delimiter: " "
      - type: move
        from: attributes.payload
        to: body
      - type: remove
        field: attributes.audit_ts
      - type: add
        field: attributes["log.type"]
        value: audit

  hostmetrics:
    root_path: / # containers use /host
    collection_interval: 10s
    scrapers:
      cpu:
      memory:
      disk:
      filesystem:
      load:

  otlp:
    protocols:
      http:
        endpoint: 127.0.0.1:4318
      grpc:
        endpoint: 127.0.0.1:4317

processors:
  resourcedetection/system:
    detectors: 
      - system
    override: false

  filter/self:
    error_mode: ignore
    logs:
      log_record:
        - log.attributes["CONTAINER_NAME"] == "hackaton"

  transform/unpack_json:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          - 'merge_maps(log.attributes, log.body, "insert") where IsMap(log.body)'
          - 'merge_maps(log.attributes, ParseJSON(log.body), "insert") where IsString(log.body) and IsMatch(log.body, "^\\{")'

  transform/enrich_logs:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          # ==========================================
          # 1. CORE & GENERAL TRANSFORMATIONS
          # ==========================================
          - 'set(log.attributes["log.type"], "kernel") where log.attributes["_TRANSPORT"] == "kernel" or log.attributes["transport"] == "kernel"'
          - 'set(resource.attributes["service.name"], log.attributes["systemd.unit"]) where log.attributes["systemd.unit"] != nil'
          
          # Hostname resolution
          - 'set(resource.attributes["hostname"], resource.attributes["host.name"]) where resource.attributes["host.name"] != nil'
          - 'set(resource.attributes["hostname"], log.attributes["host.hostname"]) where log.attributes["host.hostname"] != nil'
          - 'delete_key(resource.attributes, "host.name")'
          - 'set(log.attributes["hostname"], log.attributes["host.name"]) where log.attributes["host.name"] != nil'
          - 'delete_key(log.attributes, "host.name")'
          
          # Standard Message & Priority
          - 'set(log.body, log.attributes["MESSAGE"]) where log.body != nil'
          - 'delete_key(log.attributes, "MESSAGE")'
          - 'set(log.attributes["message_id"], log.attributes["MESSAGE_ID"]) where log.attributes["MESSAGE_ID"] != nil'
          - 'delete_key(log.attributes, "MESSAGE_ID")'
          - 'set(log.attributes["priority"], log.attributes["PRIORITY"]) where log.attributes["PRIORITY"] != nil'
          - 'delete_key(log.attributes, "PRIORITY")'

          # ==========================================
          # 2. JOURNALD / PROCESS METADATA
          # ==========================================
          - 'set(log.attributes["transport"], log.attributes["_TRANSPORT"]) where log.attributes["_TRANSPORT"] != nil'
          - 'delete_key(log.attributes, "_TRANSPORT")'
          - 'set(log.attributes["log.type"], "kernel") where log.attributes["transport"] == "kernel"'
          - 'set(log.attributes["pid"], log.attributes["_PID"]) where log.attributes["_PID"] != nil'
          - 'delete_key(log.attributes, "_PID")'
          - 'set(log.attributes["uid"], log.attributes["_UID"]) where log.attributes["_UID"] != nil'
          - 'delete_key(log.attributes, "_UID")'
          - 'set(log.attributes["gid"], log.attributes["_GID"]) where log.attributes["_GID"] != nil'
          - 'delete_key(log.attributes, "_GID")'
          - 'set(log.attributes["comm"], log.attributes["_COMM"]) where log.attributes["_COMM"] != nil'
          - 'delete_key(log.attributes, "_COMM")'
          - 'set(log.attributes["exe"], log.attributes["_EXE"]) where log.attributes["_EXE"] != nil'
          - 'delete_key(log.attributes, "_EXE")'
          - 'set(log.attributes["cmdline"], log.attributes["_CMDLINE"]) where log.attributes["_CMDLINE"] != nil'
          - 'delete_key(log.attributes, "_CMDLINE")'
          - 'set(log.attributes["cap_effective"], log.attributes["_CAP_EFFECTIVE"]) where log.attributes["_CAP_EFFECTIVE"] != nil'
          - 'delete_key(log.attributes, "_CAP_EFFECTIVE")'
          - 'set(log.attributes["selinux_context"], log.attributes["_SELINUX_CONTEXT"]) where log.attributes["_SELINUX_CONTEXT"] != nil'
          - 'delete_key(log.attributes, "_SELINUX_CONTEXT")'
          - 'set(log.attributes["runtime_scope"], log.attributes["_RUNTIME_SCOPE"]) where log.attributes["_RUNTIME_SCOPE"] != nil'
          - 'delete_key(log.attributes, "_RUNTIME_SCOPE")'
          - 'set(log.attributes["tid"], log.attributes["TID"]) where log.attributes["TID"] != nil'
          - 'delete_key(log.attributes, "TID")'

          # ==========================================
          # 3. SYSTEMD METADATA
          # ==========================================
          - 'set(log.attributes["systemd_unit"], log.attributes["_SYSTEMD_UNIT"]) where log.attributes["_SYSTEMD_UNIT"] != nil'
          - 'delete_key(log.attributes, "_SYSTEMD_UNIT")'
          - 'set(log.attributes["systemd_slice"], log.attributes["_SYSTEMD_SLICE"]) where log.attributes["_SYSTEMD_SLICE"] != nil'
          - 'delete_key(log.attributes, "_SYSTEMD_SLICE")'
          - 'set(log.attributes["systemd_cgroup"], log.attributes["_SYSTEMD_CGROUP"]) where log.attributes["_SYSTEMD_CGROUP"] != nil'
          - 'delete_key(log.attributes, "_SYSTEMD_CGROUP")'
          - 'set(log.attributes["systemd_invocation_id"], log.attributes["_SYSTEMD_INVOCATION_ID"]) where log.attributes["_SYSTEMD_INVOCATION_ID"] != nil'
          - 'delete_key(log.attributes, "_SYSTEMD_INVOCATION_ID")'
          - 'set(log.attributes["systemd_owner_uid"], log.attributes["_SYSTEMD_OWNER_UID"]) where log.attributes["_SYSTEMD_OWNER_UID"] != nil'
          - 'delete_key(log.attributes, "_SYSTEMD_OWNER_UID")'
          - 'set(log.attributes["systemd_user_slice"], log.attributes["_SYSTEMD_USER_SLICE"]) where log.attributes["_SYSTEMD_USER_SLICE"] != nil'
          - 'delete_key(log.attributes, "_SYSTEMD_USER_SLICE")'
          - 'set(log.attributes["systemd_user_unit"], log.attributes["_SYSTEMD_USER_UNIT"]) where log.attributes["_SYSTEMD_USER_UNIT"] != nil'
          - 'delete_key(log.attributes, "_SYSTEMD_USER_UNIT")'
          - 'set(log.attributes["unit"], log.attributes["UNIT"]) where log.attributes["UNIT"] != nil'
          - 'delete_key(log.attributes, "UNIT")'
          - 'set(log.attributes["invocation_id"], log.attributes["INVOCATION_ID"]) where log.attributes["INVOCATION_ID"] != nil'
          - 'delete_key(log.attributes, "INVOCATION_ID")'

          # ==========================================
          # 4. CONTAINER & PODMAN METADATA
          # ==========================================
          # General Container
          - 'set(log.attributes["log.type"], "container") where log.attributes["CONTAINER_ID"] != nil'
          - 'set(log.attributes["container_name"], log.attributes["CONTAINER_NAME"]) where log.attributes["CONTAINER_NAME"] != nil'
          - 'delete_key(log.attributes, "CONTAINER_NAME")'
          - 'set(log.attributes["container_id_full"], log.attributes["CONTAINER_ID_FULL"]) where log.attributes["CONTAINER_ID_FULL"] != nil'
          - 'delete_key(log.attributes, "CONTAINER_ID_FULL")'
          - 'set(log.attributes["container_id"], log.attributes["CONTAINER_ID"]) where log.attributes["CONTAINER_ID"] != nil'
          - 'delete_key(log.attributes, "CONTAINER_ID")'
          - 'set(log.attributes["log.type"], "container") where log.attributes["container_id"] != nil and log.attributes["log.type"] == nil'
          
          # Podman specifics
          - 'set(log.attributes["podman_event"], log.attributes["PODMAN_EVENT"]) where log.attributes["PODMAN_EVENT"] != nil'
          - 'delete_key(log.attributes, "PODMAN_EVENT")'
          - 'set(log.attributes["podman_id"], log.attributes["PODMAN_ID"]) where log.attributes["PODMAN_ID"] != nil'
          - 'delete_key(log.attributes, "PODMAN_ID")'
          - 'set(log.attributes["podman_image"], log.attributes["PODMAN_IMAGE"]) where log.attributes["PODMAN_IMAGE"] != nil'
          - 'delete_key(log.attributes, "PODMAN_IMAGE")'
          - 'set(log.attributes["podman_labels"], log.attributes["PODMAN_LABELS"]) where log.attributes["PODMAN_LABELS"] != nil'
          - 'delete_key(log.attributes, "PODMAN_LABELS")'
          - 'set(log.attributes["podman_name"], log.attributes["PODMAN_NAME"]) where log.attributes["PODMAN_NAME"] != nil'
          - 'delete_key(log.attributes, "PODMAN_NAME")'
          - 'set(log.attributes["podman_time"], log.attributes["PODMAN_TIME"]) where log.attributes["PODMAN_TIME"] != nil'
          - 'delete_key(log.attributes, "PODMAN_TIME")'
          - 'set(log.attributes["podman_type"], log.attributes["PODMAN_TYPE"]) where log.attributes["PODMAN_TYPE"] != nil'
          - 'delete_key(log.attributes, "PODMAN_TYPE")'

          # ==========================================
          # 5. SYSLOG METADATA
          # ==========================================
          - 'set(log.attributes["syslog_identifier"], log.attributes["SYSLOG_IDENTIFIER"]) where log.attributes["SYSLOG_IDENTIFIER"] != nil'
          - 'delete_key(log.attributes, "SYSLOG_IDENTIFIER")'
          - 'set(log.attributes["syslog_facility"], log.attributes["SYSLOG_FACILITY"]) where log.attributes["SYSLOG_FACILITY"] != nil'
          - 'delete_key(log.attributes, "SYSLOG_FACILITY")'
          - 'set(log.attributes["syslog_timestamp"], log.attributes["SYSLOG_TIMESTAMP"]) where log.attributes["SYSLOG_TIMESTAMP"] != nil'
          - 'delete_key(log.attributes, "SYSLOG_TIMESTAMP")'
          - 'set(log.attributes["syslog_pid"], log.attributes["SYSLOG_PID"]) where log.attributes["SYSLOG_PID"] != nil'
          - 'delete_key(log.attributes, "SYSLOG_PID")'
          - 'set(log.attributes["syslog_raw"], log.attributes["SYSLOG_RAW"]) where log.attributes["SYSLOG_RAW"] != nil'
          - 'delete_key(log.attributes, "SYSLOG_RAW")'

          # ==========================================
          # 6. AUDIT METADATA
          # ==========================================
          - 'set(log.attributes["audit_session"], log.attributes["_AUDIT_SESSION"]) where log.attributes["_AUDIT_SESSION"] != nil'
          - 'delete_key(log.attributes, "_AUDIT_SESSION")'
          - 'set(log.attributes["audit_loginuid"], log.attributes["_AUDIT_LOGINUID"]) where log.attributes["_AUDIT_LOGINUID"] != nil'
          - 'delete_key(log.attributes, "_AUDIT_LOGINUID")'
          - 'set(log.attributes["auid"], log.attributes["AUID"]) where log.attributes["AUID"] != nil'
          - 'delete_key(log.attributes, "AUID")'

          # ==========================================
          # 7. TIME, CURSOR & CODE METADATA
          # ==========================================
          - 'set(log.attributes["monotonic_timestamp"], log.attributes["__MONOTONIC_TIMESTAMP"]) where log.attributes["__MONOTONIC_TIMESTAMP"] != nil'
          - 'delete_key(log.attributes, "__MONOTONIC_TIMESTAMP")'
          - 'set(log.attributes["source_monotonic_timestamp"], log.attributes["_SOURCE_MONOTONIC_TIMESTAMP"]) where log.attributes["_SOURCE_MONOTONIC_TIMESTAMP"] != nil'
          - 'delete_key(log.attributes, "_SOURCE_MONOTONIC_TIMESTAMP")'
          - 'set(log.attributes["cursor"], log.attributes["__CURSOR"]) where log.attributes["__CURSOR"] != nil'
          - 'delete_key(log.attributes, "__CURSOR")'
          - 'set(log.attributes["code_func"], log.attributes["CODE_FUNC"]) where log.attributes["CODE_FUNC"] != nil'
          - 'delete_key(log.attributes, "CODE_FUNC")'
          - 'set(log.attributes["code_line"], log.attributes["CODE_LINE"]) where log.attributes["CODE_LINE"] != nil'
          - 'delete_key(log.attributes, "CODE_LINE")'
          - 'set(log.attributes["code_file"], log.attributes["CODE_FILE"]) where log.attributes["CODE_FILE"] != nil'
          - 'delete_key(log.attributes, "CODE_FILE")'

          # ==========================================
          # 8. COREDUMP METADATA
          # ==========================================
          - 'set(log.attributes["coredump_cgroup"], log.attributes["COREDUMP_CGROUP"]) where log.attributes["COREDUMP_CGROUP"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_CGROUP")'
          - 'set(log.attributes["coredump_cmdline"], log.attributes["COREDUMP_CMDLINE"]) where log.attributes["COREDUMP_CMDLINE"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_CMDLINE")'
          - 'set(log.attributes["coredump_comm"], log.attributes["COREDUMP_COMM"]) where log.attributes["COREDUMP_COMM"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_COMM")'
          - 'set(log.attributes["coredump_container_cmdline"], log.attributes["COREDUMP_CONTAINER_CMDLINE"]) where log.attributes["COREDUMP_CONTAINER_CMDLINE"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_CONTAINER_CMDLINE")'
          - 'set(log.attributes["coredump_cwd"], log.attributes["COREDUMP_CWD"]) where log.attributes["COREDUMP_CWD"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_CWD")'
          - 'set(log.attributes["coredump_dumpable"], log.attributes["COREDUMP_DUMPABLE"]) where log.attributes["COREDUMP_DUMPABLE"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_DUMPABLE")'
          - 'set(log.attributes["coredump_environ"], log.attributes["COREDUMP_ENVIRON"]) where log.attributes["COREDUMP_ENVIRON"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_ENVIRON")'
          - 'set(log.attributes["coredump_exe"], log.attributes["COREDUMP_EXE"]) where log.attributes["COREDUMP_EXE"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_EXE")'
          - 'set(log.attributes["coredump_filename"], log.attributes["COREDUMP_FILENAME"]) where log.attributes["COREDUMP_FILENAME"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_FILENAME")'
          - 'set(log.attributes["coredump_gid"], log.attributes["COREDUMP_GID"]) where log.attributes["COREDUMP_GID"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_GID")'
          - 'set(log.attributes["coredump_hostname"], log.attributes["COREDUMP_HOSTNAME"]) where log.attributes["COREDUMP_HOSTNAME"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_HOSTNAME")'
          - 'set(log.attributes["coredump_open_fds"], log.attributes["COREDUMP_OPEN_FDS"]) where log.attributes["COREDUMP_OPEN_FDS"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_OPEN_FDS")'
          - 'set(log.attributes["coredump_owner_uid"], log.attributes["COREDUMP_OWNER_UID"]) where log.attributes["COREDUMP_OWNER_UID"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_OWNER_UID")'
          - 'set(log.attributes["coredump_package_json"], log.attributes["COREDUMP_PACKAGE_JSON"]) where log.attributes["COREDUMP_PACKAGE_JSON"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_PACKAGE_JSON")'
          - 'set(log.attributes["coredump_pid"], log.attributes["COREDUMP_PID"]) where log.attributes["COREDUMP_PID"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_PID")'
          - 'set(log.attributes["coredump_proc_auxv"], log.attributes["COREDUMP_PROC_AUXV"]) where log.attributes["COREDUMP_PROC_AUXV"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_PROC_AUXV")'
          - 'set(log.attributes["coredump_proc_cgroup"], log.attributes["COREDUMP_PROC_CGROUP"]) where log.attributes["COREDUMP_PROC_CGROUP"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_PROC_CGROUP")'
          - 'set(log.attributes["coredump_proc_limits"], log.attributes["COREDUMP_PROC_LIMITS"]) where log.attributes["COREDUMP_PROC_LIMITS"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_PROC_LIMITS")'
          - 'set(log.attributes["coredump_proc_maps"], log.attributes["COREDUMP_PROC_MAPS"]) where log.attributes["COREDUMP_PROC_MAPS"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_PROC_MAPS")'
          - 'set(log.attributes["coredump_proc_mountinfo"], log.attributes["COREDUMP_PROC_MOUNTINFO"]) where log.attributes["COREDUMP_PROC_MOUNTINFO"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_PROC_MOUNTINFO")'
          - 'set(log.attributes["coredump_proc_status"], log.attributes["COREDUMP_PROC_STATUS"]) where log.attributes["COREDUMP_PROC_STATUS"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_PROC_STATUS")'
          - 'set(log.attributes["coredump_rlimit"], log.attributes["COREDUMP_RLIMIT"]) where log.attributes["COREDUMP_RLIMIT"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_RLIMIT")'
          - 'set(log.attributes["coredump_root"], log.attributes["COREDUMP_ROOT"]) where log.attributes["COREDUMP_ROOT"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_ROOT")'
          - 'set(log.attributes["coredump_signal"], log.attributes["COREDUMP_SIGNAL"]) where log.attributes["COREDUMP_SIGNAL"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_SIGNAL")'
          - 'set(log.attributes["coredump_signal_name"], log.attributes["COREDUMP_SIGNAL_NAME"]) where log.attributes["COREDUMP_SIGNAL_NAME"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_SIGNAL_NAME")'
          - 'set(log.attributes["coredump_slice"], log.attributes["COREDUMP_SLICE"]) where log.attributes["COREDUMP_SLICE"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_SLICE")'
          - 'set(log.attributes["coredump_timestamp"], log.attributes["COREDUMP_TIMESTAMP"]) where log.attributes["COREDUMP_TIMESTAMP"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_TIMESTAMP")'
          - 'set(log.attributes["coredump_uid"], log.attributes["COREDUMP_UID"]) where log.attributes["COREDUMP_UID"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_UID")'
          - 'set(log.attributes["coredump_unit"], log.attributes["COREDUMP_UNIT"]) where log.attributes["COREDUMP_UNIT"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_UNIT")'
          - 'set(log.attributes["coredump_user_unit"], log.attributes["COREDUMP_USER_UNIT"]) where log.attributes["COREDUMP_USER_UNIT"] != nil'
          - 'delete_key(log.attributes, "COREDUMP_USER_UNIT")'

          # ==========================================
          # 9. DROPPED / NOISY FIELDS (CLEANUP)
          # ==========================================
          - 'delete_key(log.attributes, "_BOOT_ID")'
          - 'delete_key(log.attributes, "_MACHINE_ID")'
          - 'delete_key(log.attributes, "_HOSTNAME")'
          - 'delete_key(log.attributes, "_SOURCE_REALTIME_TIMESTAMP")'
          - 'delete_key(log.attributes, "_STREAM_ID")'
          - 'delete_key(log.attributes, "_SOURCE_BOOTTIME_TIMESTAMP")'

exporters:
  otlphttp/loki:
    endpoint: 'https://loki.apps.example.com/otlp'
    retry_on_failure:
      enabled: true
      initial_interval: 60s
      max_elapsed_time: 600s
      max_interval: 120s
    sending_queue:
      block_on_overflow: false
      num_consumers: 20
      queue_size: 10000
      storage: file_storage
    timeout: 120s
    tls:
      insecure_skip_verify: true

  otlphttp/prometheusremotewrite:
    endpoint: 'https://prometheus.apps.example.com/api/v1/otlp'
    # metrics are not queue-able for a long period of time
    # besides that Prometheus will reject, more recent occurances will also
    # drop metrics of older timestamps if seen by prometheus
    retry_on_failure:
      enabled: true
      initial_interval: 5s 
      max_elapsed_time: 120s
      max_interval: 30s
    timeout: 20s
    tls:
      insecure_skip_verify: true

  otlp/tracecollector:
    endpoint: 'https://tracecollector.apps.example.com:443'
    retry_on_failure:
      enabled: true
      initial_interval: 60s
      max_elapsed_time: 600s
      max_interval: 120s
    sending_queue:
      block_on_overflow: false
      num_consumers: 20
      queue_size: 100000
      storage: file_storage
    tls:
      insecure_skip_verify: true

  debug:
    sampling_initial: 5
    sampling_thereafter: 200
    verbosity: detailed

extensions:
  file_storage:
    compaction:
      cleanup_on_start: false
      directory: /queue/compact/
      on_start: false
    create_directory: true
    directory: /queue/work/
    fsync: true
    timeout: 1s

service:
  extensions:
    - file_storage
  pipelines:
    logs:
      receivers: 
        - journald
        - filelog/audit
        - otlp
      processors: 
        - resourcedetection/system
        - transform/unpack_json
        - filter/self
        - transform/enrich_logs
      exporters: 
        - debug
    metrics:
      receivers: 
        - hostmetrics
        - otlp
      processors: 
        - resourcedetection/system
      exporters: 
        - debug
    traces:
      receivers:
        - otlp
      exporters:
        - debug
